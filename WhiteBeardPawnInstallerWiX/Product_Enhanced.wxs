<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <!-- 
    WhiteBeard Pawn Plugin Installer - Main WiX Configuration
    
    This file defines:
    - Product metadata and versioning
    - Installation directory structure
    - Features and components
    - Custom actions for license validation and MT5 detection
    - UI sequence and dialogs
  -->

  <!-- ============================================ -->
  <!-- PRODUCT DEFINITION -->
  <!-- ============================================ -->
  <Product 
    Id="*"
    Name="WhiteBeard Pawn Plugin"
    Language="1033"
    Version="1.0.0.0"
    Manufacturer="WhiteBeard"
    UpgradeCode="12345678-1234-1234-1234-123456789012">

    <!-- ============================================ -->
    <!-- PACKAGE METADATA -->
    <!-- ============================================ -->
    <Package 
      InstallerVersion="200" 
      Compressed="yes" 
      InstallScope="perMachine"
      Description="WhiteBeard Pawn Plugin for MetaTrader 5" />

    <!-- Media/Cabinet file settings for file compression -->
    <MediaTemplate EmbedCab="yes" />

    <!-- ============================================ -->
    <!-- INSTALLATION DIRECTORY STRUCTURE -->
    <!-- ============================================ -->
    <StandardDirectory Id="ProgramFilesFolder">
      <Directory Id="MANUFACTURERFOLDER" Name="WhiteBeard">
        <Directory Id="INSTALLFOLDER" Name="Pawn Plugin" />
      </Directory>
    </StandardDirectory>

    <!-- Also create ProgramData directory for license storage -->
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="WHITEBEARD_DATA_DIR" Name="WhiteBeard" />
    </StandardDirectory>

    <!-- ============================================ -->
    <!-- FEATURE DEFINITIONS -->
    <!-- ============================================ -->
    <Feature 
      Id="ProductFeature" 
      Title="WhiteBeard Pawn Plugin" 
      Level="1" 
      Description="Installs the WhiteBeard Pawn Plugin for MetaTrader 5">
      
      <!-- Plugin binary component -->
      <ComponentRef Id="PluginFilesComponent" />
      
      <!-- Registry entries component -->
      <ComponentRef Id="RegistryEntriesComponent" />

    </Feature>

    <!-- ============================================ -->
    <!-- INSTALLER PROPERTIES -->
    <!-- ============================================ -->
    <!-- These properties are populated by custom actions -->
    <Property Id="LICENSE_PATH" Value="" />
    <Property Id="COMPANY_NAME" Value="" />
    <Property Id="COMPANY_EMAIL" Value="" />
    <Property Id="MT5_ROOT" Value="" />
    <Property Id="LICENSE_AGREEMENT_ACCEPTED" Value="0" />
    <Property Id="ARPNOMODIFY" Value="1" />
    <Property Id="ARPNOREPAIR" Value="1" />

    <!-- Prerequisite: Administrator rights -->
    <Condition Message="Administrator privileges are required to install this application.">
      Privileged
    </Condition>

    <!-- Prerequisite: Windows version -->
    <Condition Message="This installer requires Windows 7 or later.">
      VersionNT >= 601
    </Condition>

    <!-- ============================================ -->
    <!-- CUSTOM ACTIONS - UI SEQUENCE -->
    <!-- ============================================ -->
    <!-- These run during the UI phase (before installation) -->
    <InstallUISequence>
      <!-- Step 1: Search for and validate license file -->
      <Custom Action="SearchAndValidateLicenseAction" Before="DialogSequence" />
      
      <!-- Step 2: Verify license with remote API -->
      <Custom Action="VerifyLicenseWithAPIAction" After="SearchAndValidateLicenseAction" />
      
      <!-- Step 3: Detect MetaTrader 5 installation directory -->
      <Custom Action="DetectMT5DirectoryAction" After="VerifyLicenseWithAPIAction" />
    </InstallUISequence>

    <!-- ============================================ -->
    <!-- CUSTOM ACTIONS - EXECUTE SEQUENCE -->
    <!-- ============================================ -->
    <!-- These run during actual installation -->
    <InstallExecuteSequence>
      <!-- Install plugin files to MT5 directory -->
      <Custom Action="InstallPluginFilesAction" After="InstallFiles" />
    </InstallExecuteSequence>

    <!-- ============================================ -->
    <!-- CUSTOM ACTION DEFINITIONS -->
    <!-- ============================================ -->

    <!-- Action: SearchAndValidateLicense -->
    <CustomAction 
      Id="SearchAndValidateLicenseAction"
      BinaryRef="CustomActionsBinary"
      DllEntry="SearchAndValidateLicense"
      Execute="immediate"
      Return="check"
      Impersonate="no" />

    <!-- Action: VerifyLicenseWithAPI -->
    <CustomAction 
      Id="VerifyLicenseWithAPIAction"
      BinaryRef="CustomActionsBinary"
      DllEntry="VerifyLicenseWithAPI"
      Execute="immediate"
      Return="check"
      Impersonate="no" />

    <!-- Action: DetectMT5Directory -->
    <CustomAction 
      Id="DetectMT5DirectoryAction"
      BinaryRef="CustomActionsBinary"
      DllEntry="DetectMT5Directory"
      Execute="immediate"
      Return="check"
      Impersonate="no" />

    <!-- Action: InstallPluginFiles -->
    <CustomAction 
      Id="InstallPluginFilesAction"
      BinaryRef="CustomActionsBinary"
      DllEntry="InstallPluginFiles"
      Execute="deferred"
      Return="check"
      Impersonate="no" />

    <!-- Reference to compiled custom actions DLL -->
    <Binary 
      Id="CustomActionsBinary" 
      SourcePath="path/to/CustomActions.dll" />

    <!-- ============================================ -->
    <!-- USER INTERFACE -->
    <!-- ============================================ -->
    <UI>
      <!-- Text styles for UI elements -->
      <TextStyle Id="DlgTitleFont" FaceName="Tahoma" Size="9" Bold="yes" />
      <TextStyle Id="DlgFont" FaceName="Tahoma" Size="8" />
      <TextStyle Id="DlgBoldFont" FaceName="Tahoma" Size="8" Bold="yes" />
      
      <!-- Image/Icon (optional) -->
      <!-- <Image Id="BannerImage" SourcePath="path/to/banner.bmp" /> -->

      <!-- ========== WELCOME DIALOG ========== -->
      <Dialog Id="WelcomeDlg" Width="370" Height="270" Title="WhiteBeard Pawn Plugin Installer">
        <Control Id="Title" Type="Text" X="20" Y="20" Width="330" Height="20" 
                 FontId="DlgTitleFont" Text="Welcome to WhiteBeard Pawn Plugin Installer" />
        <Control Id="Description" Type="Text" X="20" Y="50" Width="330" Height="120" 
                 Text="This installer will guide you through the process of installing WhiteBeard Pawn Plugin for MetaTrader 5.&#10;&#10;The installer will:&#10;1. Validate your license file&#10;2. Verify the license with our servers&#10;3. Detect your MetaTrader 5 installation&#10;4. Copy the plugin to the correct directory&#10;&#10;Click Next to continue." />
        <Control Id="NextButton" Type="PushButton" X="236" Y="230" Width="56" Height="18" 
                 Text="Next &gt;" Default="yes" TabSkip="no" />
        <Control Id="CancelButton" Type="PushButton" X="292" Y="230" Width="56" Height="18" 
                 Cancel="yes" Text="Cancel" TabSkip="no" />
      </Dialog>

      <!-- ========== LICENSE SELECTION DIALOG ========== -->
      <DialogRef Id="LicenseSelectionDlg" />

      <!-- ========== COMPANY INFO DIALOG ========== -->
      <DialogRef Id="CompanyInfoDlg" />

      <!-- ========== MT5 DIRECTORY DIALOG ========== -->
      <DialogRef Id="MT5DirectoryDlg" />

      <!-- ========== LICENSE AGREEMENT DIALOG ========== -->
      <DialogRef Id="LicenseAgreementDlg" />

      <!-- ========== INSTALLATION PROGRESS DIALOG ========== -->
      <Dialog Id="ProgressDlg" Width="370" Height="270" Title="Installation Progress">
        <Control Id="Title" Type="Text" X="20" Y="20" Width="330" Height="20" 
                 FontId="DlgTitleFont" Text="Installation Progress" />
        <Control Id="ProgressBar" Type="ProgressBar" X="20" Y="60" Width="330" Height="20" 
                 ProgressBlocks="yes" />
        <Control Id="StatusText" Type="Text" X="20" Y="100" Width="330" Height="100" 
                 Text="Installing WhiteBeard Pawn Plugin...&#10;&#10;This may take a few moments." />
        <Control Id="CancelButton" Type="PushButton" X="292" Y="230" Width="56" Height="18" 
                 Cancel="yes" Text="Cancel" Disabled="yes" />
      </Dialog>

      <!-- ========== FINISHED DIALOG ========== -->
      <Dialog Id="FinishedDlg" Width="370" Height="270" Title="Installation Complete">
        <Control Id="Title" Type="Text" X="20" Y="20" Width="330" Height="20" 
                 FontId="DlgTitleFont" Text="Installation Completed Successfully" />
        <Control Id="Description" Type="Text" X="20" Y="50" Width="330" Height="120" 
                 Text="WhiteBeard Pawn Plugin has been successfully installed.&#10;&#10;The plugin has been copied to your MetaTrader 5 Plugins directory and is ready to use.&#10;&#10;You may need to restart MetaTrader 5 for the plugin to be recognized.&#10;&#10;Thank you for using WhiteBeard Pawn Plugin!" />
        <Control Id="FinishButton" Type="PushButton" X="236" Y="230" Width="56" Height="18" 
                 Text="Finish" Default="yes" TabSkip="no" />
      </Dialog>

      <!-- ========== USER EXIT DIALOG ========== -->
      <Dialog Id="UserExitDlg" Width="370" Height="270" Title="Installation Cancelled">
        <Control Id="Title" Type="Text" X="20" Y="20" Width="330" Height="20" 
                 FontId="DlgTitleFont" Text="Installation Cancelled" />
        <Control Id="Description" Type="Text" X="20" Y="50" Width="330" Height="120" 
                 Text="You have chosen to cancel the installation of WhiteBeard Pawn Plugin.&#10;&#10;If you wish to install this product later, you can run this installer again.&#10;&#10;For support, please visit: www.whitebeard.ai" />
        <Control Id="FinishButton" Type="PushButton" X="236" Y="230" Width="56" Height="18" 
                 Text="Finish" Default="yes" TabSkip="no" />
      </Dialog>

      <!-- ========== ERROR DIALOG ========== -->
      <Dialog Id="ErrorDlg" Width="370" Height="270" Title="Installation Error">
        <Control Id="Title" Type="Text" X="20" Y="20" Width="330" Height="20" 
                 FontId="DlgTitleFont" Text="Installation Error" />
        <Control Id="Description" Type="Text" X="20" Y="50" Width="330" Height="120" 
                 Text="An error occurred during installation.&#10;&#10;Please contact WhiteBeard support if the problem persists.&#10;Website: www.whitebeard.ai&#10;Email: info@whitebeard.ai&#10;Phone: +1 646 422 8482" />
        <Control Id="FinishButton" Type="PushButton" X="236" Y="230" Width="56" Height="18" 
                 Text="Finish" Default="yes" TabSkip="no" />
      </Dialog>

      <!-- ========== DIALOG SEQUENCE ========== -->
      <!-- Define the flow between dialogs -->
      <Publish Dialog="WelcomeDlg" Control="NextButton" Event="NewDialog" Value="LicenseSelectionDlg" />
      
      <Publish Dialog="LicenseSelectionDlg" Control="BackButton" Event="NewDialog" Value="WelcomeDlg" />
      <Publish Dialog="LicenseSelectionDlg" Control="NextButton" Event="NewDialog" Value="CompanyInfoDlg" />
      
      <Publish Dialog="CompanyInfoDlg" Control="BackButton" Event="NewDialog" Value="LicenseSelectionDlg" />
      <Publish Dialog="CompanyInfoDlg" Control="NextButton" Event="NewDialog" Value="MT5DirectoryDlg" />
      
      <Publish Dialog="MT5DirectoryDlg" Control="BackButton" Event="NewDialog" Value="CompanyInfoDlg" />
      <Publish Dialog="MT5DirectoryDlg" Control="NextButton" Event="NewDialog" Value="LicenseAgreementDlg" />
      
      <Publish Dialog="LicenseAgreementDlg" Control="BackButton" Event="NewDialog" Value="MT5DirectoryDlg" />
      <Publish Dialog="LicenseAgreementDlg" Control="NextButton" Event="DoAction" Value="InstallPluginFilesAction" />

      <!-- End dialogs -->
      <Publish Dialog="UserExitDlg" Control="Finish" Event="EndDialog" Value="Return" />
      <Publish Dialog="FinishedDlg" Control="FinishButton" Event="EndDialog" Value="Return" />
      <Publish Dialog="ErrorDlg" Control="FinishButton" Event="EndDialog" Value="Return" />

      <!-- Common cancel buttons -->
      <Publish Dialog="WelcomeDlg" Control="CancelButton" Event="NewDialog" Value="UserExitDlg" />
      <Publish Dialog="LicenseSelectionDlg" Control="CancelButton" Event="NewDialog" Value="UserExitDlg" />
      <Publish Dialog="CompanyInfoDlg" Control="CancelButton" Event="NewDialog" Value="UserExitDlg" />
      <Publish Dialog="MT5DirectoryDlg" Control="CancelButton" Event="NewDialog" Value="UserExitDlg" />
      <Publish Dialog="LicenseAgreementDlg" Control="CancelButton" Event="NewDialog" Value="UserExitDlg" />

    </UI>

  </Product>

  <!-- ============================================ -->
  <!-- COMPONENTS & FILES -->
  <!-- ============================================ -->

  <!-- Plugin Files Component -->
  <Component Id="PluginFilesComponent" Directory="INSTALLFOLDER" Bitness="x64">
    <!-- Plugin DLL -->
    <File 
      Id="PluginDLL" 
      Name="PawnPlugin64.dll" 
      Source="path/to/PawnPlugin64.dll"
      Vital="yes"
      KeyPath="yes" />
  </Component>

  <!-- Registry Entries Component -->
  <Component Id="RegistryEntriesComponent" Directory="INSTALLFOLDER" Bitness="x64">
    <!-- Registry key for installation tracking -->
    <RegistryValue 
      Root="HKLM" 
      Key="Software\WhiteBeard\PawnPlugin" 
      Name="Installed" 
      Value="1" 
      Type="integer"
      KeyPath="yes" />
    
    <!-- Version information -->
    <RegistryValue 
      Root="HKLM" 
      Key="Software\WhiteBeard\PawnPlugin" 
      Name="Version" 
      Value="1.0.0" 
      Type="string" />
    
    <!-- Installation directory -->
    <RegistryValue 
      Root="HKLM" 
      Key="Software\WhiteBeard\PawnPlugin" 
      Name="InstallDir" 
      Value="[INSTALLFOLDER]" 
      Type="string" />
  </Component>

</Wix>
